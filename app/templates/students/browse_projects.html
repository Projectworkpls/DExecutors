{% extends "base.html" %}

{% block title %}Browse Projects - DExecutors{% endblock %}

{% block content %}
<style>
.browse-container {
    max-width: 900px;
    margin: 40px auto 0 auto;
    padding: 0 16px;
}
.browse-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
}
.browse-header h2 {
    margin: 0;
    color: #2357d5;
    font-size: 2rem;
    font-weight: 700;
}
.project-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 28px;
}
.project-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 16px rgba(60, 90, 200, 0.08);
    padding: 24px 20px 20px 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.project-card h3 {
    margin: 0 0 10px 0;
    color: #2d3a60;
    font-size: 1.15rem;
    font-weight: 600;
}
.project-meta {
    font-size: 0.98rem;
    color: #4a5a7a;
    margin-bottom: 10px;
}
.project-card .btn-small {
    margin-top: 10px;
    font-size: 0.97rem;
    padding: 6px 16px;
    border-radius: 6px;
    background: #e7efff;
    color: #2357d5;
    border: none;
    font-weight: 600;
    transition: background 0.18s;
    text-decoration: none;
    display: inline-block;
}
.project-card .btn-small:hover {
    background: #d2e2ff;
}
.empty-state {
    margin: 48px 0;
    color: #888;
    text-align: center;
}
.submit-project-section {
    margin-top: 44px;
    background: #f8faff;
    border-radius: 10px;
    padding: 28px 22px;
    box-shadow: 0 1px 8px rgba(60,90,200,0.06);
}
.submit-project-section h3 {
    margin-top: 0;
    color: #2357d5;
    font-size: 1.13rem;
    font-weight: 700;
    margin-bottom: 18px;
}
.form-group {
    margin-bottom: 18px;
}
.form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 6px;
    color: #31416b;
}
.form-group select,
.form-group textarea,
.form-group input {
    width: 100%;
    padding: 9px 12px;
    border: 1px solid #b8c4e0;
    border-radius: 6px;
    font-size: 1rem;
    background: #fff;
    transition: border-color 0.2s;
}
.form-group select:focus,
.form-group textarea:focus,
.form-group input:focus {
    border-color: #5b8cff;
    outline: none;
    background: #f0f6ff;
}
.btn-primary {
    background: linear-gradient(90deg, #4f8cff 0%, #2357d5 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    padding: 10px 26px;
    cursor: pointer;
    transition: background 0.2s;
}
.btn-primary:hover {
    background: linear-gradient(90deg, #2357d5 0%, #4f8cff 100%);
}
.flashes {
    list-style: none;
    padding: 0;
    margin-bottom: 18px;
}
.flashes li {
    padding: 10px 14px;
    border-radius: 5px;
    margin-bottom: 8px;
    font-size: 1rem;
}
.flash-success {
    background: #e6f9e8;
    color: #217a3a;
    border: 1px solid #b6e6c3;
}
.flash-error {
    background: #ffeaea;
    color: #b12e2e;
    border: 1px solid #f5bcbc;
}
.ai-analysis-section {
    background: #f7faff;
    border: 1px solid #d2e2ff;
    border-radius: 8px;
    padding: 18px 16px;
    margin-bottom: 18px;
}
.ai-analysis-section h4 {
    margin: 0 0 6px 0;
    color: #2357d5;
    font-size: 1.1rem;
    font-weight: 600;
}
.ai-analysis-section pre {
    background: #f0f5ff;
    color: #31416b;
    padding: 10px;
    border-radius: 6px;
    font-size: 0.97rem;
    margin: 0 0 8px 0;
    overflow-x: auto;
}
.ai-analysis-note {
    font-size: 0.96rem;
    color: #5b7acb;
    margin: 0;
}
@media (max-width: 800px) {
    .project-list { grid-template-columns: 1fr; }
}
</style>

<div class="browse-container">
    <div class="browse-header">
        <h2>Browse Projects</h2>
        <a href="{{ url_for('students.student_dashboard') }}" class="btn-secondary">Back to Dashboard</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="flash-{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {% if projects %}
    <div class="project-list">
        {% for project in projects %}
        <div class="project-card">
            <h3>{{ project.title }}</h3>
            <div class="project-meta">
                <span>Budget: â‚¹{{ project.budget }}</span>
                {% if project.deadline %}
                <span>Deadline: {{ project.deadline|date('d M Y') }}</span>
                {% endif %}
                {% if project.ai_feasibility_score %}
                <span>AI Score: {{ project.ai_feasibility_score }}%</span>
                {% endif %}
            </div>
            <div>
                <form method="POST" action="{{ url_for('students.apply_for_project', project_id=project.id) }}">
                    <button type="submit" class="btn-small">Apply</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>No open projects available at the moment.</p>
    </div>
    {% endif %}

    <div class="submit-project-section">
        <h3>Submit Your Project Work</h3>
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="project_title">Select Project</label>
                <select name="project_title" id="project_title" required>
                    <option value="" disabled {% if not request.form.project_title %}selected{% endif %}>Select a project</option>
                    {% for project in projects %}
                    <option value="{{ project.title }}"
                        {% if (request.form.project_title == project.title) or (analysis and analysis.get('project_title') == project.title) %}selected{% endif %}>
                        {{ project.title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="submission_description">Project Submission Description</label>
                <textarea name="submission_description" id="submission_description" rows="4" required placeholder="Describe your completed work">{{
                    request.form.submission_description or (analysis and analysis.get('description')) or '' }}</textarea>
            </div>
            <div class="form-group">
                <label for="submission_file">Upload File (optional)</label>
                <input type="file" name="submission_file" id="submission_file" accept=".pdf,.doc,.docx,.zip,.rar,.jpg,.png">
            </div>

            {% if analysis %}
            <input type="hidden" name="ai_analysis_json" value="{{ analysis|tojson }}">
            <div class="ai-analysis-section">
                <h4>AI Analysis Result</h4>
                <pre>{{ analysis | tojson(indent=2) }}</pre>
                <p class="ai-analysis-note">If the analysis looks good, you can submit your project for admin approval.</p>
            </div>
            {% endif %}

            <div>
                {% if not analysis %}
                <button type="submit" name="action" value="analyze" class="btn-primary">Analyze with AI</button>
                {% endif %}
                {% if analysis %}
                <button type="submit" name="action" value="submit" class="btn-primary">Submit for Approval</button>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}